<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rocket League 2D â€“ Primera DivisiÃ³n</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#11162a; --panel2:#0f1426; --accent:#00d1ff; --text:#e7ecff;
      --good:#4ade80; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 700px at 50% 50%, #0e1533 0%, #0b1020 70%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    #app{display:grid;grid-template-columns:320px 1fr;gap:16px;max-width:1600px;margin:0 auto;padding:12px; height: 100%; background: var(--bg);}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #1e274a;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:14px}
    h1{font-size:22px;margin:0 0 8px;letter-spacing:.3px}
    label{font-size:13px;opacity:.9}
    select,button,input[type="checkbox"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #263159;background:#0c1330;color:var(--text)}
    select{appearance:none}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .controls{font-size:13px;line-height:1.6;opacity:.9}
    .btn{cursor:pointer;background:linear-gradient(180deg,#0aa4ff,#067ad6);border:none;font-weight:700;letter-spacing:.3px}
    .btn:active{transform:translateY(1px)}
    .bar{height:10px;background:#1a254d;border-radius:20px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#00e1ff,#30ffa6)}
    canvas{width:100%;height:100%;display:block;border-radius:16px;border:1px solid #1b2345;background:radial-gradient(1200px 700px at 50% 50%, #0b1d3b 0%, #061126 70%); cursor: crosshair;}
    #hud{position:absolute;inset:0;pointer-events:none}
    .score{position:absolute;top:10px;left:50%;transform:translateX(-50%);font-size:28px;font-weight:800;text-shadow:0 2px 0 #0009}
    .timer{position:absolute;top:10px;right:18px;font-weight:700;padding:6px 10px;background:#0008;border-radius:10px}
    .team-tag{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:20px}
    .pill{padding:6px 10px;border-radius:999px;background:#0008;border:1px solid #ffffff22;font-size:12px}
    .left{position:absolute;bottom:12px;left:12px}
    .right{position:absolute;bottom:12px;right:12px}
    .goal-banner{position:absolute;left:50%;top:45%;transform:translate(-50%,-50%);font-size:38px;font-weight:900;background:#000a;padding:10px 16px;border-radius:14px;opacity:0;transition:opacity .3s}
    .goal-banner.show{opacity:1}
    .winner{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:40px;font-weight:900;background:#000c;padding:12px 18px;border-radius:16px;display:none}
    .note{font-size:12px;opacity:.7;margin-top:4px}
    .tiny{font-size:11px;opacity:.7}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#111936;border:1px solid #28345f;border-bottom-width:3px;border-radius:6px;padding:2px 6px;margin:0 2px}
    @media (max-width: 1100px){ #app{grid-template-columns:1fr} }
  </style>
</head>
<body>
<div id="app">
  <div class="card">
    <h1>Rocket League 2D âš½ðŸ‡¦ðŸ‡·</h1>
    <p style="opacity:.85;margin-top:6px">Partido 1v1 local inspirado en Rocket League, con autos tematizados por equipos de la Primera DivisiÃ³n.</p>
    <div class="row" style="margin-top:10px">
      <div><label>Equipo Jugador 1</label><select id="team1"></select></div>
      <div><label>Equipo Jugador 2 / CPU</label><select id="team2"></select></div>
    </div>
    <div class="row" style="margin-top:10px">
      <div><label>DuraciÃ³n (minutos)</label><select id="minutes"><option value="3">3</option><option value="5">5</option><option value="8">8</option></select></div>
      <div><label>Meta de goles</label><select id="goalLimit"><option value="0">Sin lÃ­mite</option><option value="5">5</option><option value="7">7</option><option value="10">10</option></select></div>
    </div>
    <div class="row" style="margin-top:10px">
        <div><label>Velocidad del Juego</label><select id="gameSpeed"><option value="0.8">Lento</option><option value="1.0" selected>Normal</option><option value="1.25">RÃ¡pido</option></select></div>
        <div><label>Control con Mouse/TÃ¡ctil</label><select id="pointerControl"><option value="none">Nadie</option><option value="p1">Jugador 1</option><option value="p2">Jugador 2</option></select></div>
    </div>
    <div class="row" style="margin-top:10px">
        <div><label><input type="checkbox" id="touch2p" /> Modo TÃ¡ctil 2J</label></div>
        <div><label><input type="checkbox" id="cpu" /> J2 es CPU</label></div>
        <div><label><input type="checkbox" id="golden" /> Gol de oro</label></div>
    </div>

    <div class="controls card" style="margin-top:12px;padding:10px">
      <div class="row">
        <div><strong>J1 (Teclado)</strong><br><span class="kbd">W</span><span class="kbd">A</span><span class="kbd">S</span><span class="kbd">D</span> Mover<br><span class="kbd">Shift</span> turbo</div>
        <div><strong>J2 (Teclado)</strong><br>Flechas para mover<br><span class="kbd">Ctrl Der</span> turbo</div>
      </div>
       <div style="margin-top: 8px; border-top: 1px solid #1e274a; padding-top: 8px;">
          <strong>Controles Alternativos</strong><br>
          Mouse: Asignar arriba. Mover para girar, Clicks para acelerar/turbo.<br>
          TÃ¡ctil 2J: J1 en mitad izq., J2 en mitad der. 2Âº dedo para turbo.
        </div>
    </div>

    <button id="start" class="btn" style="margin-top:12px">Iniciar Partido</button>
    <div class="row" style="margin-top:8px">
        <button id="reset">Reiniciar</button>
        <button id="fullscreenBtn">Pantalla Completa</button>
    </div>

    <div style="margin-top:14px">
      <label>Turbo Jugador 1</label><div class="bar"><span id="boost1" style="width:100%"></span></div>
      <label style="margin-top:6px;display:block">Turbo Jugador 2</label><div class="bar"><span id="boost2" style="width:100%"></span></div>
      <p class="note">RecargÃ¡ turbo pasando por los orbes de energÃ­a âœ¨</p>
    </div>

    <p class="tiny">Hecho en HTML5 Canvas. FÃ­sica simple 2D.</p>
  </div>

  <div class="card" style="position:relative;min-height:520px">
    <canvas id="game" width="1200" height="700" aria-label="Campo de juego"></canvas>
    <div id="hud">
      <div class="score" id="score">0 â€” 0</div>
      <div class="timer" id="timer">03:00</div>
      <div class="goal-banner" id="goal">Â¡GOL!</div>
      <div class="team-tag" id="tags"></div>
      <div class="winner" id="winner"></div>
      <div class="pill left">J1: WASD + Shift</div>
      <div class="pill right">J2: Flechas + Ctrl</div>
    </div>
  </div>
</div>

<script>
const TEAMS = [
  { name: 'Boca Juniors', primary:'#0033A0', secondary:'#F7D117' }, { name: 'River Plate', primary:'#FFFFFF', secondary:'#E30613' },
  { name: 'Racing Club', primary:'#67C8FF', secondary:'#FFFFFF' }, { name: 'Independiente', primary:'#E1001A', secondary:'#FFFFFF' },
  { name: 'San Lorenzo', primary:'#002B5C', secondary:'#C8102E' }, { name: 'HuracÃ¡n', primary:'#FFFFFF', secondary:'#E41B13' },
  { name: 'Estudiantes LP', primary:'#ED1C24', secondary:'#FFFFFF' }, { name: 'Gimnasia LP', primary:'#0B2D5B', secondary:'#FFFFFF' },
  { name: 'Rosario Central', primary:'#F7D117', secondary:'#0033A0' }, { name: 'Newell\'s', primary:'#D50000', secondary:'#111111' },
  { name: 'VÃ©lez Sarsfield', primary:'#17408B', secondary:'#FFFFFF' }, { name: 'Argentinos Jrs', primary:'#EE2E24', secondary:'#FFFFFF' },
  { name: 'LanÃºs', primary:'#6E0E0A', secondary:'#FFFFFF' }, { name: 'Banfield', primary:'#1B8F3A', secondary:'#FFFFFF' },
  { name: 'Talleres', primary:'#001845', secondary:'#FFFFFF' }, { name: 'Defensa y Justicia', primary:'#0FA958', secondary:'#F7D117' },
  { name: 'Godoy Cruz', primary:'#2D4DA7', secondary:'#FFFFFF' }, { name: 'Tigre', primary:'#1B3A8A', secondary:'#D91F26' },
  { name: 'Platense', primary:'#4E342E', secondary:'#FFFFFF' }, { name: 'UniÃ³n', primary:'#E30613', secondary:'#FFFFFF' },
  { name: 'ColÃ³n', primary:'#E10600', secondary:'#111111' },
];

const sel1 = document.getElementById('team1'), sel2 = document.getElementById('team2');
TEAMS.forEach((t,i)=>{
  const o1=document.createElement('option');o1.value=i;o1.textContent=t.name;sel1.appendChild(o1);
  const o2=document.createElement('option');o2.value=i;o2.textContent=t.name;sel2.appendChild(o2);
});
sel1.value=0; sel2.value=1;

const tags = document.getElementById('tags');
function renderTags(){
  tags.innerHTML='';
  const t1 = TEAMS[+sel1.value], t2 = TEAMS[+sel2.value];
  const el1 = document.createElement('div'); el1.className='pill'; el1.textContent='J1: '+t1.name; el1.style.borderColor=t1.secondary+'55'; el1.style.background = '#0008';
  const el2 = document.createElement('div'); el2.className='pill'; el2.textContent='J2: '+t2.name; el2.style.borderColor=t2.secondary+'55'; el2.style.background = '#0008';
  tags.appendChild(el1); tags.appendChild(el2);
}
renderTags();
sel1.addEventListener('change',renderTags); sel2.addEventListener('change',renderTags);

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let W = canvas.width, H = canvas.height;

const FIELD = { left:60, right:W-60, top:40, bottom:H-40 };
const GOAL = { width:36, height:260 };

let state = { running:false, countdown: 3, time: 3*60, goalLimit: 0, golden:false, score:[0,0], lastGoalTime:0, whoScored:-1 };

function car(teamIndex, x, y, facing){
  return { teamIndex, x, y, r:24, angle:facing, vx:0, vy:0, accel:0.28, turn:0.035, maxSpeed:8, friction:0.985, boost:100, boosting:false, boostPower:0.6, boostDrain:25/60, boostGain:14/60 };
}
let p1, p2;

const ball = { x:W/2, y:H/2, r:16, vx:0, vy:0, bounciness:0.98, friction:0.998, max:16 };
const orbs = [ {x:W*0.25,y:H*0.35,r:14,t:0,cool:0}, {x:W*0.75,y:H*0.35,r:14,t:0,cool:0}, {x:W*0.25,y:H*0.65,r:14,t:0,cool:0}, {x:W*0.75,y:H*0.65,r:14,t:0,cool:0} ];

const keys = {};
window.addEventListener('keydown',e=>{ keys[e.code]=true; if(e.code==='Space') e.preventDefault(); });
window.addEventListener('keyup',e=>{ keys[e.code]=false; });

const mouse = { x: W/2, y: H/2, left: false, right: false };
canvas.addEventListener('mousemove', e => { const rect = canvas.getBoundingClientRect(); mouse.x = (e.clientX - rect.left) * (W / rect.width); mouse.y = (e.clientY - rect.top) * (H / rect.height); });
canvas.addEventListener('mousedown', e => { if (e.button === 0) mouse.left = true; if (e.button === 2) mouse.right = true; });
canvas.addEventListener('mouseup', e => { if (e.button === 0) mouse.left = false; if (e.button === 2) mouse.right = false; });
canvas.addEventListener('contextmenu', e => e.preventDefault());

// --- LÃ³gica TÃ¡ctil para 2 Jugadores ---
const touch1 = { x: W*0.25, y: H/2, active: false, boost: false, id: -1 };
const touch2 = { x: W*0.75, y: H/2, active: false, boost: false, id: -1 };
const activeTouches = new Map();

function handleTouch(e) {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const screenWidth = rect.width;

    for (const touch of e.changedTouches) {
        const touchX = (touch.clientX - rect.left);
        const touchState = (touchX < screenWidth / 2) ? touch1 : touch2;
        
        if (e.type === 'touchstart') {
            if (touchState.id === -1) { // Primer dedo para este jugador
                touchState.id = touch.identifier;
                touchState.active = true;
            } else { // Segundo dedo (turbo)
                touchState.boost = true;
            }
            activeTouches.set(touch.identifier, touchState);
        } else if (e.type === 'touchend' || e.type === 'touchcancel') {
            const endedTouchState = activeTouches.get(touch.identifier);
            if (endedTouchState) {
                if (endedTouchState.id === touch.identifier) { // Dedo principal levantado
                    endedTouchState.active = false;
                    endedTouchState.boost = false;
                    endedTouchState.id = -1;
                } else { // Dedo de turbo levantado
                    endedTouchState.boost = false;
                }
            }
            activeTouches.delete(touch.identifier);
        }
        
        if (touchState.active) {
            touchState.x = touchX * (W / rect.width);
            touchState.y = (touch.clientY - rect.top) * (H / rect.height);
        }
    }
}
canvas.addEventListener('touchstart', handleTouch, { passive: false });
canvas.addEventListener('touchmove', handleTouch, { passive: false });
canvas.addEventListener('touchend', handleTouch, { passive: false });
canvas.addEventListener('touchcancel', handleTouch, { passive: false });


function cpuLogic(me, opp){
  const target = {x:ball.x, y:ball.y}; const dx = target.x - me.x, dy = target.y - me.y;
  const desired = Math.atan2(dy, dx); let diff = wrapAngle(desired - me.angle);
  if (diff>0.05) me.angle += me.turn; else if (diff<-0.05) me.angle -= me.turn;
  const aligned = Math.abs(diff) < 0.35, dist = Math.hypot(dx,dy);
  if (aligned) { me.vx += Math.cos(me.angle)*me.accel*0.85; me.vy += Math.sin(me.angle)*me.accel*0.85; }
  const towardsGoal = me===p2 ? (Math.cos(me.angle)>0.4) : (Math.cos(me.angle)<-0.4);
  me.boosting = aligned && dist<220 && towardsGoal && me.boost>5;
}

function wrapAngle(a){ while(a>Math.PI) a-=Math.PI*2; while(a<-Math.PI) a+=Math.PI*2; return a; }

function resetKickoff(){
  ball.x=W/2; ball.y=H/2; ball.vx=(Math.random()*2-1)*1.2; ball.vy=(Math.random()*2-1)*1.2;
  p1.x=FIELD.left+160; p1.y=H/2+(Math.random()*60-30); p1.vx=p1.vy=0; p1.angle=0; p1.boost=Math.min(100,p1.boost+20);
  p2.x=FIELD.right-160; p2.y=H/2+(Math.random()*60-30); p2.vx=p2.vy=0; p2.angle=Math.PI; p2.boost=Math.min(100,p2.boost+20);
  state.countdown=3; state.whoScored=-1; document.getElementById('goal').classList.remove('show'); renderTags();
}

function drawCar(c){
  const team = TEAMS[c.teamIndex];
  ctx.save(); ctx.translate(c.x, c.y); ctx.rotate(c.angle);
  ctx.globalAlpha=0.35; ctx.fillStyle='#000'; ctx.beginPath(); ctx.ellipse(0, 10, c.r*1.1, c.r*0.7, 0, 0, Math.PI*2); ctx.fill();
  ctx.globalAlpha=1; const grad = ctx.createLinearGradient(-c.r,0,c.r,0);
  grad.addColorStop(0, team.primary); grad.addColorStop(1, team.secondary); ctx.fillStyle = grad;
  roundRect(ctx, -c.r, -c.r*0.7, c.r*2, c.r*1.4, 10, true);
  ctx.fillStyle = team.secondary + 'AA'; ctx.fillRect(-c.r*0.9,-6,c.r*1.8,12);
  ctx.fillStyle = '#0e1726'; roundRect(ctx, -c.r*0.5, -c.r*0.4, c.r*1.0, c.r*0.8, 6, true);
  ctx.fillStyle = '#111'; ctx.beginPath(); ctx.arc(-c.r*0.8, c.r*0.6, 6, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(c.r*0.8, c.r*0.6, 6, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#fff'; ctx.font='bold 11px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(shortTeam(TEAMS[c.teamIndex].name), 0, -c.r*0.8);
  if (c.boosting && c.boost>0){
    ctx.fillStyle = 'rgba(255,200,50,0.9)'; ctx.beginPath(); ctx.moveTo(-c.r-6, -6); ctx.lineTo(-c.r-6, 6); ctx.lineTo(-c.r-6- (6+Math.random()*10), 0); ctx.closePath(); ctx.fill();
  }
  ctx.restore();
}
function shortTeam(n){ if(n==='Argentinos Jrs') return 'Argentinos'; if(n==='Estudiantes LP') return 'Estudiantes'; if(n==='Gimnasia LP') return 'Gimnasia'; return n.split(' ')[0]; }
function roundRect(ctx,x,y,w,h,r,fill){
  const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); if(fill) ctx.fill(); else ctx.stroke();
}

function drawField(){
  const g = ctx.createLinearGradient(0,FIELD.top,0,FIELD.bottom); g.addColorStop(0,'#0b2a3d'); g.addColorStop(1,'#0a2140');
  ctx.fillStyle=g; ctx.fillRect(FIELD.left,FIELD.top,FIELD.right-FIELD.left,FIELD.bottom-FIELD.top);
  ctx.globalAlpha=0.09; ctx.fillStyle='#fff';
  for(let i=0;i<10;i++) ctx.fillRect(FIELD.left, FIELD.top + i*((FIELD.bottom-FIELD.top)/10), FIELD.right-FIELD.left, (FIELD.bottom-FIELD.top)/20);
  ctx.globalAlpha=1; ctx.strokeStyle='#6cc6ff44'; ctx.lineWidth=4; ctx.strokeRect(FIELD.left,FIELD.top,FIELD.right-FIELD.left,FIELD.bottom-FIELD.top);
  ctx.beginPath(); ctx.strokeStyle='#bfe9ff66'; ctx.lineWidth=3; ctx.moveTo(W/2,FIELD.top); ctx.lineTo(W/2,FIELD.bottom); ctx.stroke();
  ctx.beginPath(); ctx.arc(W/2,(FIELD.top+FIELD.bottom)/2,80,0,Math.PI*2); ctx.stroke();
  ctx.fillStyle='#88ddff22'; ctx.fillRect(FIELD.left-GOAL.width, (H-GOAL.height)/2, GOAL.width, GOAL.height);
  ctx.fillRect(FIELD.right, (H-GOAL.height)/2, GOAL.width, GOAL.height);
}

function drawBall(){
  ctx.globalAlpha=0.35; ctx.fillStyle='#000'; ctx.beginPath(); ctx.ellipse(ball.x, ball.y+10, ball.r*1.05, ball.r*0.6, 0, 0, Math.PI*2); ctx.fill();
  ctx.globalAlpha=1; const g = ctx.createRadialGradient(ball.x-5,ball.y-6,6, ball.x,ball.y, ball.r);
  g.addColorStop(0,'#ffffff'); g.addColorStop(1,'#b8c6ff'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
  ctx.strokeStyle='#dfe7ff'; ctx.globalAlpha=0.55; ctx.lineWidth=1.2; ctx.beginPath(); ctx.arc(ball.x,ball.y,ball.r*0.55,0,Math.PI*2); ctx.stroke(); ctx.globalAlpha=1;
}

function drawOrbs(){
  orbs.forEach(o=>{
    if(o.cool>0){ ctx.globalAlpha=0.35; ctx.fillStyle='#888'; ctx.beginPath(); ctx.arc(o.x,o.y,o.r,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; return; }
    const t = (performance.now()/1000 + o.t)%1, rr = o.r + Math.sin(t*2*Math.PI)*2;
    const grad = ctx.createRadialGradient(o.x,o.y,4,o.x,o.y,rr);
    grad.addColorStop(0,'#eaffff'); grad.addColorStop(1,'#00d1ff'); ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(o.x,o.y,rr,0,Math.PI*2); ctx.fill();
  });
}

function drawPointerIndicators() {
    const pointerControl = document.getElementById('pointerControl').value;
    if (pointerControl !== 'none') {
        ctx.save(); ctx.strokeStyle = '#ffffffaa'; ctx.lineWidth = 2; ctx.beginPath();
        ctx.arc(mouse.x, mouse.y, 15, 0, Math.PI * 2);
        ctx.moveTo(mouse.x - 10, mouse.y); ctx.lineTo(mouse.x + 10, mouse.y);
        ctx.moveTo(mouse.x, mouse.y - 10); ctx.lineTo(mouse.x, mouse.y + 10);
        ctx.stroke(); ctx.restore();
    }
    if (document.getElementById('touch2p').checked) {
        [touch1, touch2].forEach(t => {
            if (t.active) {
                ctx.save(); ctx.strokeStyle = t.boost ? 'var(--warn)' : 'var(--accent)'; ctx.lineWidth = 3; ctx.globalAlpha = 0.7;
                ctx.beginPath(); ctx.arc(t.x, t.y, 30, 0, Math.PI * 2); ctx.stroke();
                if(t.boost) { ctx.fillStyle = 'rgba(245, 158, 11, 0.2)'; ctx.fill(); }
                ctx.restore();
            }
        });
    }
}

function updateCar(c, input){
  if(input.up){ c.vx += Math.cos(c.angle)*c.accel; c.vy += Math.sin(c.angle)*c.accel; }
  if(input.down){ c.vx -= Math.cos(c.angle)*c.accel*0.6; c.vy -= Math.sin(c.angle)*c.accel*0.6; }
  const speed = Math.hypot(c.vx,c.vy), turnScale = Math.min(1, speed/3);
  if(input.left) c.angle -= c.turn*turnScale; if(input.right) c.angle += c.turn*turnScale;
  c.boosting = !!input.boost && c.boost>0;
  if(c.boosting){ c.vx += Math.cos(c.angle)*c.boostPower; c.vy += Math.sin(c.angle)*c.boostPower; c.boost = Math.max(0, c.boost - c.boostDrain*60*dt); }
  else c.boost = Math.min(100, c.boost + c.boostGain*60*dt);
  const max = c.maxSpeed + (c.boosting?4:0);
  const sp = Math.hypot(c.vx,c.vy); if(sp>max){ c.vx *= max/sp; c.vy *= max/sp; }
  c.x += c.vx; c.y += c.vy; c.vx *= c.friction; c.vy *= c.friction;
  const r=c.r;
  if(c.x-r < FIELD.left){ c.x=FIELD.left+r; c.vx*=-0.4; } if(c.x+r > FIELD.right){ c.x=FIELD.right-r; c.vx*=-0.4; }
  if(c.y-r < FIELD.top){ c.y=FIELD.top+r; c.vy*=-0.4; } if(c.y+r > FIELD.bottom){ c.y=FIELD.bottom-r; c.vy*=-0.4; }
}

function carInputP1(){ return { up:keys['KeyW'], down:keys['KeyS'], left:keys['KeyA'], right:keys['KeyD'], boost:keys['ShiftLeft'] }; }
function carInputP2(){ return { up:keys['ArrowUp'], down:keys['ArrowDown'], left:keys['ArrowLeft'], right:keys['ArrowRight'], boost:keys['ControlRight'] }; }
function carInputPointer(c){
  const dx = mouse.x - c.x, dy = mouse.y - c.y; const desiredAngle = Math.atan2(dy, dx);
  let angleDiff = wrapAngle(desiredAngle - c.angle), turnLeft = false, turnRight = false;
  if (angleDiff > 0.05) turnRight = true; else if (angleDiff < -0.05) turnLeft = true;
  return { up: mouse.left, down: false, left: turnLeft, right: turnRight, boost: mouse.right };
}
function carInputTouch(c, touchState){
  if (!touchState.active) return { up: false, down: false, left: false, right: false, boost: false };
  const dx = touchState.x - c.x, dy = touchState.y - c.y; const desiredAngle = Math.atan2(dy, dx);
  let angleDiff = wrapAngle(desiredAngle - c.angle), turnLeft = false, turnRight = false;
  if (angleDiff > 0.1) turnRight = true; else if (angleDiff < -0.1) turnLeft = true;
  return { up: true, down: false, left: turnLeft, right: turnRight, boost: touchState.boost };
}

function ballPhysics(){
  ball.x += ball.vx; ball.y += ball.vy; ball.vx *= ball.friction; ball.vy *= ball.friction;
  if(Math.hypot(ball.vx,ball.vy)>ball.max){ const s=Math.hypot(ball.vx,ball.vy); ball.vx*=ball.max/s; ball.vy*=ball.max/s; }
  if(ball.y-ball.r < FIELD.top){ ball.y=FIELD.top+ball.r; ball.vy*=-ball.bounciness; }
  if(ball.y+ball.r > FIELD.bottom){ ball.y=FIELD.bottom-ball.r; ball.vy*=-ball.bounciness; }
  const isOutsideGoalY = Math.abs(ball.y - H/2) >= GOAL.height/2;
  if(ball.x-ball.r < FIELD.left && isOutsideGoalY){ ball.x=FIELD.left+ball.r; ball.vx*=-ball.bounciness; }
  if(ball.x+ball.r > FIELD.right && isOutsideGoalY){ ball.x=FIELD.right-ball.r; ball.vx*=-ball.bounciness; }
}

function collideCarBall(c){
  const R = c.r*0.9 + ball.r; const dx=ball.x-c.x, dy=ball.y-c.y; const d2=dx*dx+dy*dy;
  if(d2 < R*R){
    const d = Math.sqrt(d2)||0.0001, nx=dx/d, ny=dy/d;
    const overlap = R-d; ball.x += nx*overlap; ball.y += ny*overlap;
    const relvx = ball.vx - c.vx, relvy = ball.vy - c.vy; const dot = relvx*nx + relvy*ny;
    ball.vx = (ball.vx - 1.8*dot*nx) + c.vx*0.35; ball.vy = (ball.vy - 1.8*dot*ny) + c.vy*0.35;
  }
}

function collideCars(a,b){
  const R = a.r + b.r; const dx=b.x-a.x, dy=b.y-a.y; const d2=dx*dx+dy*dy; if(d2<R*R){
    const d=Math.sqrt(d2)||0.0001, nx=dx/d, ny=dy/d; const overlap=R-d;
    a.x -= nx*overlap/2; a.y -= ny*overlap/2; b.x += nx*overlap/2; b.y += ny*overlap/2;
    const pax=a.vx, pay=a.vy; a.vx=b.vx*0.5; a.vy=b.vy*0.5; b.vx=pax*0.5; b.vy=pay*0.5;
  }
}

function checkGoals(){
  const inLeftGoal = ball.x-ball.r < FIELD.left && Math.abs(ball.y - H/2) < GOAL.height/2;
  const inRightGoal = ball.x+ball.r > FIELD.right && Math.abs(ball.y - H/2) < GOAL.height/2;
  if(inLeftGoal){ scoreGoal(1); } else if(inRightGoal){ scoreGoal(0); }
}

function scoreGoal(who){
  state.score[who]++; state.whoScored=who; state.lastGoalTime=performance.now();
  document.getElementById('goal').classList.add('show'); updateScore();
  if(state.goalLimit>0 && (state.score[0]>=state.goalLimit || state.score[1]>=state.goalLimit)){ finishMatch(); return; }
  resetKickoff();
}

function updateScore(){ document.getElementById('score').textContent = state.score[0] + ' â€” ' + state.score[1]; }

function finishMatch(){
  state.running=false;
  const w = state.score[0]===state.score[1] ? -1 : (state.score[0]>state.score[1]?0:1);
  const name = w===-1 ? 'Empate' : `GanÃ³ ${w===0?TEAMS[p1.teamIndex].name:TEAMS[p2.teamIndex].name}`;
  const winEl = document.getElementById('winner'); winEl.textContent=name; winEl.style.display='block';
}

function tickTimer(dt){
  if(!state.running || state.countdown>0) return;
  state.time -= dt; if(state.time<0){
    if(state.golden && state.score[0]===state.score[1]){ state.time=0; } else { finishMatch(); }
  }
  const t = Math.max(0, state.time);
  const m = Math.floor(t/60).toString().padStart(2,'0'), s = Math.floor(t%60).toString().padStart(2,'0');
  document.getElementById('timer').textContent = `${m}:${s}`;
}

let last=performance.now(), dt=0;
function loop(now){
  dt = Math.min(0.05, (now-last)/1000); last=now;
  ctx.clearRect(0,0,W,H);
  drawField(); drawOrbs();

  if(state.running){
    if(state.countdown>0){
      const cd = Math.ceil(state.countdown);
      ctx.fillStyle='#ffffffee'; ctx.font='900 80px system-ui'; ctx.textAlign='center'; ctx.fillText(cd, W/2, H/2-140);
      state.countdown -= dt; if(state.countdown<0) state.countdown=0;
    } else {
      const pointerControl = document.getElementById('pointerControl').value;
      const touch2P = document.getElementById('touch2p').checked;
      const cpuOn = document.getElementById('cpu').checked;
      
      let in1, in2;
      // P1 Input
      if (pointerControl === 'p1') in1 = carInputPointer(p1);
      else if (touch2P) in1 = carInputTouch(p1, touch1);
      else in1 = carInputP1();
      
      // P2 Input
      if (cpuOn) { cpuLogic(p2, p1); in2 = {}; }
      else if (pointerControl === 'p2') in2 = carInputPointer(p2);
      else if (touch2P) in2 = carInputTouch(p2, touch2);
      else in2 = carInputP2();

      updateCar(p1,in1); updateCar(p2,in2);
      
      orbs.forEach(o=>{ o.cool=Math.max(0,o.cool-dt); [p1,p2].forEach(c=>{ if(Math.hypot(c.x-o.x,c.y-o.y)<o.r+c.r*0.6 && o.cool<=0){ c.boost=Math.min(100,c.boost+60); o.cool=6; } }); });
      ballPhysics(); collideCarBall(p1); collideCarBall(p2); collideCars(p1,p2); checkGoals();
      if(state.golden && state.time<=0 && state.countdown===0 && state.whoScored!==-1) finishMatch();
    }
  }

  drawBall(); drawCar(p1); drawCar(p2);
  drawPointerIndicators();

  document.getElementById('boost1').style.width = p1.boost.toFixed(0)+'%';
  document.getElementById('boost2').style.width = p2.boost.toFixed(0)+'%';

  tickTimer(dt);
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function startMatch(){
  const speedMultiplier = +document.getElementById('gameSpeed').value;
  state.time = +document.getElementById('minutes').value * 60;
  state.goalLimit = +document.getElementById('goalLimit').value;
  state.golden = document.getElementById('golden').checked;
  
  p1 = car(+sel1.value, FIELD.left+160, H/2, 0);
  p2 = car(+sel2.value, FIELD.right-160, H/2, Math.PI);

  [p1, p2].forEach(c => {
      c.accel = 0.28 * speedMultiplier;
      c.maxSpeed = 8 * speedMultiplier;
      c.boostPower = 0.6 * speedMultiplier;
  });

  resetKickoff();
  state.score=[0,0]; updateScore();
  document.getElementById('winner').style.display='none';
  state.running=true;
}

document.getElementById('start').addEventListener('click', startMatch);
document.getElementById('reset').addEventListener('click', ()=>{ state.running=false; state.score=[0,0]; updateScore(); state.time=180; document.getElementById('timer').textContent='03:00'; document.getElementById('winner').style.display='none'; startMatch(); });

document.getElementById('fullscreenBtn').addEventListener('click', () => {
  const appEl = document.getElementById('app');
  if (!document.fullscreenElement) {
    appEl.requestFullscreen().catch(err => {
      console.error(`Error al activar pantalla completa: ${err.message} (${err.name})`);
    });
  } else {
    document.exitFullscreen();
  }
});

startMatch();
</script>
</body>
</html>
